# ğŸŒ Application Load Balancer (ALB) for ECS

**æœ€æ–°ã®æ›´æ–°**: 2024å¹´12æœˆ - å®Œå…¨å‹•ä½œç¢ºèªæ¸ˆã¿

ECSçµ±åˆã«ç‰¹åŒ–ã—ãŸApplication Load Balancer (ALB)ã‚’æ§‹ç¯‰ã™ã‚‹Terraformãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚IPãƒ™ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ã€SSLçµ‚ç«¯ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æœ€é©åŒ–ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—çµ±åˆã‚’è‡ªå‹•åŒ–ã—ã€ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‹ç”¨ã‚’æ”¯æ´ã—ã¾ã™ã€‚

## ğŸ“‹ æ¦‚è¦

ECSæœ€é©åŒ–ã•ã‚ŒãŸãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚SSLè¨¼æ˜æ›¸ç®¡ç†ã€ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®šã€ECSã‚µãƒ¼ãƒ“ã‚¹çµ±åˆã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®šã‚’è‡ªå‹•åŒ–ã—ã€æœ¬æ ¼çš„ãªWebã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é‹ç”¨ã‚’æ”¯æ´ã—ã¾ã™ã€‚

## âœ¨ 2024å¹´12æœˆã®ç‰¹å¾´

### ğŸŒ **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼æ©Ÿèƒ½**
- âœ… **ECSæœ€é©åŒ–** - IPãƒ™ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ»é«˜é€Ÿãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- âœ… **SSLçµ‚ç«¯** - HTTPSå¯¾å¿œãƒ»è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- âœ… **å‹•ä½œç¢ºèªæ¸ˆã¿** - Terraform 1.0+, AWS Provider 5.x

### ğŸ” **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½**
- âœ… **SSLè¨¼æ˜æ›¸çµ±åˆ** - ACMè¨¼æ˜æ›¸è‡ªå‹•è¨­å®š
- âœ… **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—** - é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
- âœ… **HTTPSå¼·åˆ¶** - HTTPè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### ğŸ”§ **é‹ç”¨æ©Ÿèƒ½**
- âœ… **ECSçµ±åˆ** - è‡ªå‹•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç™»éŒ²ãƒ»é™¤å»
- âœ… **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æœ€é©åŒ–** - ECSç”¨è¨­å®š
- âœ… **çµ±åˆã‚¿ã‚°æˆ¦ç•¥** - ä¸€è²«ã—ãŸãƒªã‚½ãƒ¼ã‚¹ç®¡ç†

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Application Load Balancer                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â”‚                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Load Balancer  â”‚   â”‚   Target Group   â”‚   â”‚   Security       â”‚
        â”‚   Configuration  â”‚   â”‚   Management     â”‚   â”‚   Configuration  â”‚
        â”‚                  â”‚   â”‚                  â”‚   â”‚                  â”‚
        â”‚ â”œâ”€ Multi-AZ      â”‚   â”‚ â”œâ”€ IP-based      â”‚   â”‚ â”œâ”€ HTTP/HTTPS    â”‚
        â”‚ â”œâ”€ Public/Privateâ”‚   â”‚ â”œâ”€ Health Check  â”‚   â”‚ â”œâ”€ IPv4/IPv6     â”‚
        â”‚ â”œâ”€ Scheme        â”‚   â”‚ â”œâ”€ Deregistrationâ”‚   â”‚ â”œâ”€ Ingress Rules â”‚
        â”‚ â””â”€ Security Groupâ”‚   â”‚ â””â”€ ECS Integrationâ”‚   â”‚ â””â”€ Port 80/443   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                      â”‚                      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚                   â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   HTTP Listener  â”‚ â”‚   HTTPS Listener â”‚ â”‚   ECS Service    â”‚
           â”‚   (Port 80)      â”‚ â”‚   (Port 443)     â”‚ â”‚   Integration    â”‚
           â”‚                  â”‚ â”‚                  â”‚ â”‚                  â”‚
           â”‚ â”œâ”€ 301 Redirect  â”‚ â”‚ â”œâ”€ SSL Terminationâ”‚ â”‚ â”œâ”€ Auto Register â”‚
           â”‚ â”œâ”€ to HTTPS      â”‚ â”‚ â”œâ”€ Certificate   â”‚ â”‚ â”œâ”€ Health Check  â”‚
           â”‚ â””â”€ Security      â”‚ â”‚ â”œâ”€ Default Actionâ”‚ â”‚ â”œâ”€ Auto Deregisterâ”‚
           â”‚   Enhancement    â”‚ â”‚ â””â”€ Forwarding    â”‚ â”‚ â””â”€ Task Lifecycle â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ä¸»è¦æ©Ÿèƒ½

### ğŸŒ **ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼æ©Ÿèƒ½**
- **ãƒãƒ«ãƒAZé…ç½®** - é«˜å¯ç”¨æ€§ãƒ»éšœå®³å¯¾å¿œ
- **IPãƒ™ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—** - ECS Fargateæœ€é©åŒ–
- **HTTP/HTTPSå¯¾å¿œ** - SSLçµ‚ç«¯ãƒ»è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—çµ±åˆ** - é©åˆ‡ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### ğŸ” **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½**
- **SSLè¨¼æ˜æ›¸çµ±åˆ** - ACMè¨¼æ˜æ›¸è‡ªå‹•è¨­å®š
- **HTTPSå¼·åˆ¶** - HTTPè‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆ301ï¼‰
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—** - ãƒãƒ¼ãƒˆ80/443ã®é©åˆ‡ãªåˆ¶å¾¡
- **IPv4/IPv6å¯¾å¿œ** - ç¾ä»£çš„ãªãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å¯¾å¿œ

### ğŸ”§ **ECSçµ±åˆæ©Ÿèƒ½**
- **è‡ªå‹•ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç™»éŒ²** - ECSã‚¿ã‚¹ã‚¯èµ·å‹•æ™‚è‡ªå‹•ç™»éŒ²
- **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æœ€é©åŒ–** - ECSç”¨è¨­å®šï¼ˆ15ç§’é–“éš”ï¼‰
- **é«˜é€Ÿãƒ‡ãƒ¬ã‚¸ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³** - 30ç§’ã§ã‚¿ã‚¹ã‚¯åˆ‡ã‚Šé›¢ã—
- **ã‚¿ã‚¹ã‚¯ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«** - èµ·å‹•ãƒ»åœæ­¢æ™‚ã®è‡ªå‹•å‡¦ç†

### ğŸ“Š **ç›£è¦–ãƒ»é‹ç”¨æ©Ÿèƒ½**
- **CloudWatchçµ±åˆ** - ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãƒ»ãƒ­ã‚°è‡ªå‹•åé›†
- **ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°** - S3ãƒã‚±ãƒƒãƒˆè‡ªå‹•å‡ºåŠ›
- **çµ±åˆã‚¿ã‚°æˆ¦ç•¥** - ä¸€è²«ã—ãŸãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
- **é‹ç”¨ã‚³ãƒãƒ³ãƒ‰** - AWS CLIæ“ä½œè‡ªå‹•åŒ–

## ğŸ”§ å‰ææ¡ä»¶

### ğŸ“‹ å¿…è¦ãªç’°å¢ƒ

| è¦ä»¶             | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | èª¬æ˜                 |
| ---------------- | ---------- | -------------------- |
| **Terraform**    | >= 1.0     | æœ€æ–°ã®æ§‹æ–‡ãƒ»æ©Ÿèƒ½å¯¾å¿œ |
| **AWS Provider** | >= 5.0     | æœ€æ–°ã®ALBæ©Ÿèƒ½        |
| **AWS CLI**      | >= 2.0     | èªè¨¼ãƒ»æ“ä½œç”¨         |

### ğŸ”‘ å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹

| ãƒªã‚½ãƒ¼ã‚¹          | å¿…é ˆ | èª¬æ˜                              |
| ----------------- | ---- | --------------------------------- |
| **VPC**           | âœ…    | ALBé…ç½®ç”¨VPC                      |
| **ã‚µãƒ–ãƒãƒƒãƒˆ**    | âœ…    | æœ€ä½2ã¤ã®AZã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆ |
| **SSLè¨¼æ˜æ›¸**     | âœ…    | ACMè¨¼æ˜æ›¸ï¼ˆHTTPSç”¨ï¼‰              |
| **ECSã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼** | âŒ    | çµ±åˆæ™‚ã«å¿…è¦                      |

## ğŸ“Š è¨­å®šé …ç›®

### ğŸ”‘ å¿…é ˆå¤‰æ•°

| å¤‰æ•°å                | èª¬æ˜                    | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | å¿…é ˆ |
| --------------------- | ----------------------- | ------------ | ---- |
| `project`             | ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå          | `""`         | âœ…    |
| `env`                 | ç’°å¢ƒåï¼ˆdev, stg, prdï¼‰ | `""`         | âœ…    |
| `vpc_id`              | VPC ID                  | `""`         | âœ…    |
| `subnet_ids`          | ã‚µãƒ–ãƒãƒƒãƒˆIDãƒªã‚¹ãƒˆ      | `[]`         | âœ…    |
| `ssl_certificate_arn` | SSLè¨¼æ˜æ›¸ARN            | `""`         | âœ…    |

### ğŸŒ ALBåŸºæœ¬è¨­å®š

| å¤‰æ•°å                       | èª¬æ˜                   | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤    | é–‹ç™ºç’°å¢ƒæ¨å¥¨    | æœ¬ç•ªç’°å¢ƒæ¨å¥¨    |
| ---------------------------- | ---------------------- | --------------- | --------------- | --------------- |
| `alb_name`                   | ALBå                  | è‡ªå‹•ç”Ÿæˆ        | è‡ªå‹•ç”Ÿæˆ        | è‡ªå‹•ç”Ÿæˆ        |
| `internal`                   | å†…éƒ¨ALB                | `false`         | `false`         | ç’°å¢ƒã«ã‚ˆã‚‹      |
| `load_balancer_type`         | ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã‚¿ã‚¤ãƒ— | `"application"` | `"application"` | `"application"` |
| `ip_address_type`            | IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚¿ã‚¤ãƒ—       | `"ipv4"`        | `"ipv4"`        | `"dualstack"`   |
| `enable_deletion_protection` | å‰Šé™¤ä¿è­·               | `false`         | `false`         | `true`          |

### ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š

| å¤‰æ•°å                  | èª¬æ˜                         | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ | æ¨å¥¨è¨­å®š               |
| ----------------------- | ---------------------------- | ------------ | ---------------------- |
| `target_group_name`     | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—å         | è‡ªå‹•ç”Ÿæˆ     | è‡ªå‹•ç”Ÿæˆ               |
| `target_type`           | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¿ã‚¤ãƒ—             | `"ip"`       | `"ip"` (ECSç”¨)         |
| `target_group_port`     | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ¼ãƒˆ     | `80`         | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãƒˆ |
| `target_group_protocol` | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãƒ—ãƒ­ãƒˆã‚³ãƒ« | `"HTTP"`     | `"HTTP"`               |
| `deregistration_delay`  | ãƒ‡ãƒ¬ã‚¸ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é…å»¶     | `30`         | ECSç”¨ã«æœ€é©åŒ–          |

### ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š

| å¤‰æ•°å                  | èª¬æ˜                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤     | æ¨å¥¨è¨­å®š                 |
| ----------------------- | -------------------------- | ---------------- | ------------------------ |
| `health_check_enabled`  | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹åŒ–       | `true`           | `true`                   |
| `health_check_path`     | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ‘ã‚¹         | `"/"`            | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å›ºæœ‰ãƒ‘ã‚¹ |
| `health_check_port`     | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ãƒˆ       | `"traffic-port"` | `"traffic-port"`         |
| `health_check_protocol` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ—ãƒ­ãƒˆã‚³ãƒ«   | `"HTTP"`         | `"HTTP"`                 |
| `health_check_interval` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–“éš”         | `15`             | ECSç”¨ã«æœ€é©åŒ–            |
| `health_check_timeout`  | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | `10`             | ECSç”¨ã«æœ€é©åŒ–            |
| `healthy_threshold`     | æ­£å¸¸ã—ãã„å€¤               | `2`              | `2`                      |
| `unhealthy_threshold`   | ç•°å¸¸ã—ãã„å€¤               | `3`              | `3`                      |

### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

| å¤‰æ•°å                     | èª¬æ˜                   | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤    | æ¨å¥¨è¨­å®š         |
| -------------------------- | ---------------------- | --------------- | ---------------- |
| `security_group_name`      | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å | è‡ªå‹•ç”Ÿæˆ        | è‡ªå‹•ç”Ÿæˆ         |
| `allowed_cidr_blocks`      | è¨±å¯CIDRãƒ–ãƒ­ãƒƒã‚¯       | `["0.0.0.0/0"]` | å¿…è¦ã«å¿œã˜ã¦åˆ¶é™ |
| `allowed_ipv6_cidr_blocks` | è¨±å¯IPv6 CIDRãƒ–ãƒ­ãƒƒã‚¯  | `["::/0"]`      | å¿…è¦ã«å¿œã˜ã¦åˆ¶é™ |

### ğŸ“Š ãƒ­ã‚°ãƒ»ç›£è¦–è¨­å®š

| å¤‰æ•°å               | èª¬æ˜                       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤        | æ¨å¥¨è¨­å®š             |
| -------------------- | -------------------------- | ------------------- | -------------------- |
| `enable_access_logs` | ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°æœ‰åŠ¹åŒ–         | `false`             | æœ¬ç•ªç’°å¢ƒã§ã¯`true`   |
| `access_logs_bucket` | ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°S3ãƒã‚±ãƒƒãƒˆ     | `""`                | å°‚ç”¨ãƒã‚±ãƒƒãƒˆ         |
| `access_logs_prefix` | ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ | `"alb-access-logs"` | ç’°å¢ƒåˆ¥ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ |

### ğŸ·ï¸ ã‚¿ã‚°è¨­å®š

| å¤‰æ•°å        | èª¬æ˜                                 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ |
| ------------- | ------------------------------------ | ------------ |
| `common_tags` | ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«é©ç”¨ã•ã‚Œã‚‹å…±é€šã‚¿ã‚° | `{}`         |

## ğŸ’¡ ä½¿ç”¨ä¾‹

### ğŸ“š åŸºæœ¬çš„ãªä½¿ç”¨ä¾‹

```hcl
module "alb" {
  source = "./load_balancer/alb/terraform"

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬è¨­å®š
  project = "webapp"
  env     = "dev"

  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
  vpc_id = "vpc-12345678"
  subnet_ids = [
    "subnet-12345678",  # ap-northeast-1a
    "subnet-87654321"   # ap-northeast-1c
  ]

  # SSLè¨¼æ˜æ›¸è¨­å®š
  ssl_certificate_arn = "arn:aws:acm:ap-northeast-1:123456789012:certificate/12345678-1234-1234-1234-123456789012"

  # å…±é€šã‚¿ã‚°
  common_tags = {
    Project     = "webapp"
    Environment = "dev"
    Owner       = "dev-team"
    ManagedBy   = "terraform"
  }
}
```

### ğŸ¢ æœ¬ç•ªç’°å¢ƒã§ã®ä½¿ç”¨ä¾‹

```hcl
module "alb_prod" {
  source = "./load_balancer/alb/terraform"

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬è¨­å®š
  project = "webapp"
  env     = "prod"

  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
  vpc_id = "vpc-12345678"
  subnet_ids = [
    "subnet-public1",   # ap-northeast-1a
    "subnet-public2",   # ap-northeast-1c
    "subnet-public3"    # ap-northeast-1d
  ]

  # SSLè¨¼æ˜æ›¸è¨­å®š
  ssl_certificate_arn = "arn:aws:acm:ap-northeast-1:123456789012:certificate/prod-cert-12345678"

  # æœ¬ç•ªç’°å¢ƒè¨­å®š
  ip_address_type = "dualstack"  # IPv4/IPv6å¯¾å¿œ
  enable_deletion_protection = true

  # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
  health_check_path = "/health"
  health_check_interval = 10
  health_check_timeout = 5
  healthy_threshold = 2
  unhealthy_threshold = 2

  # ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°è¨­å®š
  enable_access_logs = true
  access_logs_bucket = "webapp-prod-alb-logs"
  access_logs_prefix = "prod-alb-access-logs"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  allowed_cidr_blocks = [
    "10.0.0.0/8",     # å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    "172.16.0.0/12",  # å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    "192.168.0.0/16"  # å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
  ]

  # æœ¬ç•ªç’°å¢ƒç”¨ã‚¿ã‚°
  common_tags = {
    Project     = "webapp"
    Environment = "prod"
    Owner       = "devops-team"
    ManagedBy   = "terraform"
    CostCenter  = "engineering"
    CriticalService = "true"
  }
}
```

### ğŸ”§ ECSçµ±åˆã®ä½¿ç”¨ä¾‹

```hcl
# ALBä½œæˆ
module "alb" {
  source = "./load_balancer/alb/terraform"

  project = "webapp"
  env     = "stg"

  vpc_id = "vpc-12345678"
  subnet_ids = [
    "subnet-public1",
    "subnet-public2"
  ]

  ssl_certificate_arn = "arn:aws:acm:ap-northeast-1:123456789012:certificate/stg-cert-12345678"

  # ECSç”¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯æœ€é©åŒ–
  health_check_path = "/api/health"
  health_check_interval = 15
  health_check_timeout = 10
  target_group_port = 8080

  common_tags = {
    Project     = "webapp"
    Environment = "stg"
    Owner       = "qa-team"
    ManagedBy   = "terraform"
  }
}

# ECSã‚µãƒ¼ãƒ“ã‚¹ï¼ˆALBçµ±åˆï¼‰
module "ecs_service" {
  source = "./ecs/service/terraform"

  project_name = "webapp"
  environment  = "stg"
  app          = "api"
  cluster_name = "webapp-stg-ecs"

  # ALBçµ±åˆè¨­å®š
  target_group_arn = module.alb.target_group_arn
  load_balancer_container_port = 8080
  health_check_grace_period_seconds = 60

  container_image = "webapp-api:latest"
  container_port  = 8080
  desired_count   = 3

  # ALBä½œæˆå¾Œã«ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ
  depends_on = [module.alb]
}
```

### ğŸŒ å†…éƒ¨ALBã®ä½¿ç”¨ä¾‹

```hcl
module "internal_alb" {
  source = "./load_balancer/alb/terraform"

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬è¨­å®š
  project = "internal-api"
  env     = "prod"

  # å†…éƒ¨ALBè¨­å®š
  internal = true

  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚µãƒ–ãƒãƒƒãƒˆï¼‰
  vpc_id = "vpc-12345678"
  subnet_ids = [
    "subnet-private1",
    "subnet-private2"
  ]

  # å†…éƒ¨ç”¨SSLè¨¼æ˜æ›¸
  ssl_certificate_arn = "arn:aws:acm:ap-northeast-1:123456789012:certificate/internal-cert-12345678"

  # å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™
  allowed_cidr_blocks = [
    "10.0.0.0/8"    # å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿
  ]

  # å†…éƒ¨APIç”¨ã‚¿ã‚°
  common_tags = {
    Project     = "internal-api"
    Environment = "prod"
    Owner       = "backend-team"
    ManagedBy   = "terraform"
    NetworkType = "internal"
  }
}
```

### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã®ä½¿ç”¨ä¾‹

```hcl
module "secure_alb" {
  source = "./load_balancer/alb/terraform"

  # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬è¨­å®š
  project = "financial"
  env     = "prod"

  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
  vpc_id = "vpc-secure-12345678"
  subnet_ids = [
    "subnet-secure-public1",
    "subnet-secure-public2"
  ]

  # é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  enable_deletion_protection = true
  ip_address_type = "ipv4"  # IPv4ã®ã¿ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ï¼‰

  # SSLè¨¼æ˜æ›¸è¨­å®š
  ssl_certificate_arn = "arn:aws:acm:ap-northeast-1:123456789012:certificate/financial-prod-cert"

  # å³æ ¼ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
  allowed_cidr_blocks = [
    "203.0.113.0/24",  # æœ¬ç¤¾IP
    "198.51.100.0/24"  # ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ³ã‚¿ãƒ¼IP
  ]

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ç”¨ãƒ­ã‚°
  enable_access_logs = true
  access_logs_bucket = "financial-prod-security-logs"
  access_logs_prefix = "alb-security-audit"

  # å³æ ¼ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
  health_check_path = "/secure/health"
  health_check_interval = 10
  healthy_threshold = 3
  unhealthy_threshold = 2

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨ã‚¿ã‚°
  common_tags = {
    Project     = "financial"
    Environment = "prod"
    Owner       = "security-team"
    ManagedBy   = "terraform"
    SecurityLevel = "high"
    ComplianceRequired = "true"
  }
}
```

## ğŸ”§ ECSã‚µãƒ¼ãƒ“ã‚¹ã¨ã®çµ±åˆ

### ğŸ“‹ ECSã‚µãƒ¼ãƒ“ã‚¹ã§ã®è¨­å®šä¾‹

```hcl
resource "aws_ecs_service" "web" {
  name            = "${var.project}-${var.env}-web"
  cluster         = aws_ecs_cluster.main.id
  task_definition = aws_ecs_task_definition.web.arn
  desired_count   = 3
  launch_type     = "FARGATE"

  # ALBã¨ã®çµ±åˆ
  load_balancer {
    target_group_arn = module.alb.target_group_arn
    container_name   = "web"
    container_port   = 80
  }

  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®š
  network_configuration {
    subnets          = var.private_subnet_ids
    security_groups  = [aws_security_group.ecs_tasks.id]
    assign_public_ip = false
  }

  # ALBã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ä¾å­˜
  health_check_grace_period_seconds = 60

  depends_on = [
    module.alb,
    aws_ecs_task_definition.web
  ]
}
```

### ğŸ” ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®šè©³ç´°

```hcl
# ALBç”¨ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯è¨­å®š
health_check_enabled  = true
health_check_path     = "/health"
health_check_port     = "traffic-port"
health_check_protocol = "HTTP"

# ECSç”¨æœ€é©åŒ–è¨­å®š
health_check_interval    = 15  # 15ç§’é–“éš”
health_check_timeout     = 10  # 10ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
healthy_threshold        = 2   # 2å›æˆåŠŸã§æ­£å¸¸
unhealthy_threshold      = 3   # 3å›å¤±æ•—ã§ç•°å¸¸
deregistration_delay     = 30  # 30ç§’ã§é™¤å»
```

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ğŸ“‹ ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

| å•é¡Œ                   | åŸå›                        | è§£æ±ºæ–¹æ³•                    |
| ---------------------- | -------------------------- | --------------------------- |
| **ALBãŒä½œæˆã•ã‚Œãªã„**  | ã‚µãƒ–ãƒãƒƒãƒˆãƒ»VPCè¨­å®šã®å•é¡Œ  | æœ€ä½2ã¤ã®AZã®ã‚µãƒ–ãƒãƒƒãƒˆç¢ºèª |
| **SSLè¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼**    | ACMè¨¼æ˜æ›¸ã®å•é¡Œ            | è¨¼æ˜æ›¸ARNãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª   |
| **ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—** | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®å¿œç­”å•é¡Œ       | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ‘ã‚¹ç¢ºèª  |
| **ECSçµ±åˆå¤±æ•—**        | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ã®å•é¡Œ | ALB-ECSé–“é€šä¿¡è¨±å¯ç¢ºèª       |
| **403/404ã‚¨ãƒ©ãƒ¼**      | ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«ã®å•é¡Œ       | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¢ºèª    |

### ğŸ” ãƒ‡ãƒãƒƒã‚°æ‰‹é †

```bash
# 1. ALBçŠ¶æ…‹ç¢ºèª
aws elbv2 describe-load-balancers --names ${ALB_NAME}

# 2. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ç¢ºèª
aws elbv2 describe-target-groups --load-balancer-arn ${ALB_ARN}

# 3. ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå¥å…¨æ€§ç¢ºèª
aws elbv2 describe-target-health --target-group-arn ${TARGET_GROUP_ARN}

# 4. ãƒªã‚¹ãƒŠãƒ¼è¨­å®šç¢ºèª
aws elbv2 describe-listeners --load-balancer-arn ${ALB_ARN}

# 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ç¢ºèª
aws ec2 describe-security-groups --group-ids ${SECURITY_GROUP_ID}
```

### ğŸ› ï¸ è¨­å®šèª¿æ•´ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–:**
```hcl
# é«˜ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
health_check_interval = 10
health_check_timeout = 5
deregistration_delay = 15
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–:**
```hcl
# é«˜ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
enable_deletion_protection = true
allowed_cidr_blocks = ["10.0.0.0/8"]
enable_access_logs = true
```

## ğŸ”— å‡ºåŠ›å€¤

### ğŸŒ ALBæƒ…å ±

| å‡ºåŠ›å               | èª¬æ˜               |
| -------------------- | ------------------ |
| `alb_arn`            | ALB ARN            |
| `alb_dns_name`       | ALB DNSå          |
| `alb_zone_id`        | ALB Zone ID        |
| `alb_hosted_zone_id` | ALB Hosted Zone ID |

### ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±

| å‡ºåŠ›å              | èª¬æ˜                     |
| ------------------- | ------------------------ |
| `target_group_arn`  | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ARN    |
| `target_group_name` | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—å     |
| `target_group_port` | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ¼ãƒˆ |

### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±

| å‡ºåŠ›å                | èª¬æ˜                   |
| --------------------- | ---------------------- |
| `security_group_id`   | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—ID |
| `security_group_name` | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—å |

## ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯[MIT License](LICENSE)ã®ä¸‹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2024å¹´12æœˆ
**å‹•ä½œç¢ºèª**: Terraform 1.0+, AWS Provider 5.x
**ãƒ†ã‚¹ãƒˆçŠ¶æ³**: å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæ¸ˆã¿
